services:
  # MinIO - S3-compatible object storage (thay SeaweedFS, dùng 1 container, không tốn volume preallocate)
  minio:
    image: minio/minio:RELEASE.2025-09-07T16-13-09Z
    container_name: intellinews-minio
    ports:
      - "8333:9000"   # S3 API (giữ 8333 để không đổi code: endpoint_url=http://localhost:8333)
      - "9001:9001"   # Console (optional)
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: ${S3_KEY}
      MINIO_ROOT_PASSWORD: ${S3_SECRET}
      TZ: Asia/Ho_Chi_Minh
    volumes:
      - minio-data:/data
    restart: unless-stopped
    networks:
      - intellinews
  ai-db:
    image: postgres:16
    container_name: ai-postgres
    environment:
      POSTGRES_DB: intellinews_ai
      POSTGRES_USER: ${DB_USERNAME:-postgres}
      POSTGRES_PASSWORD: ${DB_PASSWORD:-your_secure_password}
    ports:
      - "5436:5432"
    volumes:
      - intellinews-ai-service-db-data:/var/lib/postgresql/data
      - ./db/init:/docker-entrypoint-initdb.d:ro  # docker-entrypoint-initdb.d/ : auto init database dir, each file will be run in alphabetical order by file name and will only be run once when the volume is newly created (with no existing data).
    networks:
      - intellinews
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${DB_USERNAME:-postgres} -d intellinews_auth" ]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

networks:
  intellinews:
    external: true

volumes:
  minio-data:
    driver: local
  intellinews-ai-service-db-data:
    external: true
