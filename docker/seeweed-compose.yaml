services:
  # Master - quản lý metadata và topology
  # volumeSizeLimitMB nhỏ (256) = mỗi volume tối đa 256MB, tránh preallocate 2GB/30GB mỗi volume
  master:
    image: chrislusf/seaweedfs:4.09
    container_name: seaweedfs-master
    ports:
      - "9333:9333"
      - "19333:19333"
    command: >
      master 
      -ip=master 
      -ip.bind=0.0.0.0
      -defaultReplication=000
      -volumeSizeLimitMB=1024
    restart: unless-stopped
    networks:
      - intellinews
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:9333/cluster/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    environment:
      - TZ=Asia/Ho_Chi_Minh

  # Volume - lưu trữ file thực tế (max=3 đủ cho vài bucket, mỗi volume ≤256MB = vài trăm MB tổng)
  volume:
    image: chrislusf/seaweedfs:4.09
    container_name: seaweedfs-volume
    ports:
      - "8080:8080"
      - "18080:18080"
      - "9325:9325"
    command: >
      volume 
      -ip=volume 
      -ip.bind=0.0.0.0
      -mserver=master:9333
      -port=8080
      -dir=/data
      -max=3
      -dataCenter=dc1
      -rack=rack1
      -metricsPort=9325
      -compactionMBps=50
      -fileSizeLimitMB=256
    volumes:
      - volume-data:/data
    depends_on:
      master:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - intellinews
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8080/status"]
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      - TZ=Asia/Ho_Chi_Minh

  # Filer - cung cấp filesystem interface
  filer:
    image: chrislusf/seaweedfs:4.09
    container_name: seaweedfs-filer
    ports:
      - "8888:8888"
      - "18888:18888"
      - "9326:9326"
    command: >
      filer 
      -ip=filer 
      -ip.bind=0.0.0.0
      -master=master:9333
      -port=8888
      -defaultReplicaPlacement=000
      -metricsPort=9326
    volumes:
      - filer-data:/data
      - ./config/filer.toml:/etc/seaweedfs/filer.toml:ro
    depends_on:
      master:
        condition: service_healthy
      volume:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - intellinews
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8888/"]
      interval: 30s
      timeout: 10s
      retries: 3
    environment:
      - TZ=Asia/Ho_Chi_Minh

  # S3 Gateway - S3-compatible API
  s3:
    image: chrislusf/seaweedfs:4.09
    container_name: seaweedfs-s3
    ports:
      - "8333:8333"
      - "9327:9327"
    command: >
      s3 
      -filer=filer:8888
      -ip.bind=0.0.0.0
      -port=8333
      -config=/etc/seaweedfs/s3.json
      -metricsPort=9327
      -allowEmptyFolder=false
      -allowDeleteBucketNotEmpty=false
    volumes:
      - ./config/s3.json:/etc/seaweedfs/s3.json:ro
    depends_on:
      filer:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - intellinews
#    healthcheck:
#      test: ["CMD", "wget", "-q", "--spider", "http://localhost:8333/"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
    environment:
      - TZ=Asia/Ho_Chi_Minh

networks:
  intellinews:
    external: true

volumes:
  master-data:
    driver: local
  volume-data:
    driver: local
  filer-data:
    driver: local